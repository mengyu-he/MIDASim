<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />

<meta name="viewport" content="width=device-width, initial-scale=1" />



<title>MIDASim package vignette</title>

<script>// Pandoc 2.9 adds attributes on both header and div. We remove the former (to
// be compatible with the behavior of Pandoc < 2.8).
document.addEventListener('DOMContentLoaded', function(e) {
  var hs = document.querySelectorAll("div.section[class*='level'] > :first-child");
  var i, h, a;
  for (i = 0; i < hs.length; i++) {
    h = hs[i];
    if (!/^h[1-6]$/i.test(h.tagName)) continue;  // it should be a header h1-h6
    a = h.attributes;
    while (a.length > 0) h.removeAttribute(a[0].name);
  }
});
</script>

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>



<style type="text/css">
  code {
    white-space: pre;
  }
  .sourceCode {
    overflow: visible;
  }
</style>
<style type="text/css" data-origin="pandoc">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */

</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    var j = 0;
    while (j < rules.length) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") {
        j++;
        continue;
      }
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') {
        j++;
        continue;
      }
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>




<style type="text/css">body {
background-color: #fff;
margin: 1em auto;
max-width: 700px;
overflow: visible;
padding-left: 2em;
padding-right: 2em;
font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
font-size: 14px;
line-height: 1.35;
}
#TOC {
clear: both;
margin: 0 0 10px 10px;
padding: 4px;
width: 400px;
border: 1px solid #CCCCCC;
border-radius: 5px;
background-color: #f6f6f6;
font-size: 13px;
line-height: 1.3;
}
#TOC .toctitle {
font-weight: bold;
font-size: 15px;
margin-left: 5px;
}
#TOC ul {
padding-left: 40px;
margin-left: -1.5em;
margin-top: 5px;
margin-bottom: 5px;
}
#TOC ul ul {
margin-left: -2em;
}
#TOC li {
line-height: 16px;
}
table {
margin: 1em auto;
border-width: 1px;
border-color: #DDDDDD;
border-style: outset;
border-collapse: collapse;
}
table th {
border-width: 2px;
padding: 5px;
border-style: inset;
}
table td {
border-width: 1px;
border-style: inset;
line-height: 18px;
padding: 5px 5px;
}
table, table th, table td {
border-left-style: none;
border-right-style: none;
}
table thead, table tr.even {
background-color: #f7f7f7;
}
p {
margin: 0.5em 0;
}
blockquote {
background-color: #f6f6f6;
padding: 0.25em 0.75em;
}
hr {
border-style: solid;
border: none;
border-top: 1px solid #777;
margin: 28px 0;
}
dl {
margin-left: 0;
}
dl dd {
margin-bottom: 13px;
margin-left: 13px;
}
dl dt {
font-weight: bold;
}
ul {
margin-top: 0;
}
ul li {
list-style: circle outside;
}
ul ul {
margin-bottom: 0;
}
pre, code {
background-color: #f7f7f7;
border-radius: 3px;
color: #333;
white-space: pre-wrap; 
}
pre {
border-radius: 3px;
margin: 5px 0px 10px 0px;
padding: 10px;
}
pre:not([class]) {
background-color: #f7f7f7;
}
code {
font-family: Consolas, Monaco, 'Courier New', monospace;
font-size: 85%;
}
p > code, li > code {
padding: 2px 0px;
}
div.figure {
text-align: center;
}
img {
background-color: #FFFFFF;
padding: 2px;
border: 1px solid #DDDDDD;
border-radius: 3px;
border: 1px solid #CCCCCC;
margin: 0 5px;
}
h1 {
margin-top: 0;
font-size: 35px;
line-height: 40px;
}
h2 {
border-bottom: 4px solid #f7f7f7;
padding-top: 10px;
padding-bottom: 2px;
font-size: 145%;
}
h3 {
border-bottom: 2px solid #f7f7f7;
padding-top: 10px;
font-size: 120%;
}
h4 {
border-bottom: 1px solid #f7f7f7;
margin-left: 8px;
font-size: 105%;
}
h5, h6 {
border-bottom: 1px solid #ccc;
font-size: 105%;
}
a {
color: #0033dd;
text-decoration: none;
}
a:hover {
color: #6666ff; }
a:visited {
color: #800080; }
a:visited:hover {
color: #BB00BB; }
a[href^="http:"] {
text-decoration: underline; }
a[href^="https:"] {
text-decoration: underline; }

code > span.kw { color: #555; font-weight: bold; } 
code > span.dt { color: #902000; } 
code > span.dv { color: #40a070; } 
code > span.bn { color: #d14; } 
code > span.fl { color: #d14; } 
code > span.ch { color: #d14; } 
code > span.st { color: #d14; } 
code > span.co { color: #888888; font-style: italic; } 
code > span.ot { color: #007020; } 
code > span.al { color: #ff0000; font-weight: bold; } 
code > span.fu { color: #900; font-weight: bold; } 
code > span.er { color: #a61717; background-color: #e3d2d2; } 
</style>




</head>

<body>




<h1 class="title toc-ignore">MIDASim package vignette</h1>



<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  TeX: { equationNumbers: { autoNumber: "AMS" } }
});
</script>
<div id="overview" class="section level1" number="1">
<h1><span class="header-section-number">1</span> Overview</h1>
<p>The MIDASim package (v0.1.0) implements the
<strong>MI</strong>crobiome <strong>DA</strong>ta
<strong>Sim</strong>ulator functions that simulate realistic microbiome
data, maintaining the distributional and taxon-taxon correlation of a
template microbiome datase. Users may also change the parameter setup in
the model to introduce ``effect’’ to facilitate simulation.</p>
<div id="required-packages" class="section level2" number="1.1">
<h2><span class="header-section-number">1.1</span> Required
packages</h2>
<p>Required packages for functions in MIDASim include: psych, MASS,
vegan, pracma, scam. These packages are all available on CRAN.</p>
</div>
<div id="installation" class="section level2" number="1.2">
<h2><span class="header-section-number">1.2</span> Installation</h2>
<p>Install from the local file (the .tar.gz file), which you can
download from <a href="https://github.com/mengyu-he/MIDASim" class="uri">https://github.com/mengyu-he/MIDASim</a>.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>devtools<span class="sc">::</span><span class="fu">install_local</span>(<span class="st">&quot;MIDASim_0.1.0.tar.gz&quot;</span>, <span class="at">dependencies =</span> <span class="cn">TRUE</span>)</span></code></pre></div>
<p>A github installation is also available via</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">install_github</span>(<span class="st">&quot;mengyu-he/MIDASim&quot;</span>)</span></code></pre></div>
</div>
<div id="open-the-vignette-in-r" class="section level2" number="1.3">
<h2><span class="header-section-number">1.3</span> Open the Vignette in
R</h2>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">browseVignettes</span>(<span class="st">&quot;MIDASim&quot;</span>)</span></code></pre></div>
<p>or</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">vignette</span>(<span class="st">&quot;MIDASim_vignette&quot;</span>, <span class="at">package =</span> <span class="st">&quot;MIDASim&quot;</span>)</span></code></pre></div>
</div>
</div>
<div id="midasim-microbiome-data-simulator" class="section level1" number="2">
<h1><span class="header-section-number">2</span> MIDASim: Microbiome
Data Simulator</h1>
<p>There are three main functions in MIDASim package:
<em>MIDASim.setup()</em>, <em>MIDASim.modify()</em>,
<em>MIDASim()</em>.</p>
<div id="template-data-description" class="section level2" number="2.1">
<h2><span class="header-section-number">2.1</span> Template data
description</h2>
<p>We demonstrate the method of MIDASim and functions in this package
using a filtered microbiome dataset of patients with IBD(Inflammatory
Bowel Disease) in Human Microbiome Project 2 (HMP2) [1]. The data can be
directly loaded through</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(<span class="st">&quot;count.ibd&quot;</span>)</span></code></pre></div>
<p>This HMP2 data were modified through package
<strong>HMP2Data</strong> on Bioconductor by filtering out samples with
library sizes smaller than 3000 and taxa that appear in less than 2
samples. The filtered data have 146 rows (samples) and 614 columns
(taxa).</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(HMP2Data)</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="fu">IBD16S</span>()</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>count.ibd <span class="ot">=</span> <span class="fu">t</span>(IBD16S_mtx[, <span class="fu">colSums</span>(IBD16S_mtx)<span class="sc">&gt;</span><span class="dv">3000</span>] )</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>count.ibd <span class="ot">=</span> count.ibd[, <span class="fu">colSums</span>(count.ibd<span class="sc">&gt;</span><span class="dv">0</span>)<span class="sc">&gt;</span><span class="dv">1</span>]</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a><span class="fu">dim</span>(count.ibd)</span></code></pre></div>
<p>Other datasets come with the package include a vaginal microbiome
dataset from HMP2 [1] and a upper-respiratory-tract microbiome dataset
[2].</p>
</div>
<div id="setup-the-midasim-model" class="section level2" number="2.2">
<h2><span class="header-section-number">2.2</span> Setup the MIDASim
model</h2>
<p>The function <em>MIDASim.setup()</em> fits the underlying MIDASim
model and extracts information from the template data and returns the
estimated parameters for microbiome simulation. MIDASim offers two
modeling options for relative abundances: nonparametric and parametric.
Both approaches utilize a two-stage procedure in which the first stage
models the presence-absence relationship between taxa and the second
stage models the non-zero values in the microbiome community. These two
approaches differ by the way how the second stage marginal distributions
are modeled. The nonparametric approach generates data that resemble the
template data better than the parametric approach. However, the
parametric approach offers modifications of the template data in more
controlled way.</p>
<p>In nonparametric mode (the default), a rank based approach is used to
obtain the relative abundances for taxa that are considered to be
non-zero in the simulated data.</p>
<p>To fit MIDASim with nonparametric mode to the <em>count.ibd</em>
data, use the following command:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>count.ibd.setup <span class="ot">=</span> <span class="fu">MIDASim.setup</span>(otu.tab, <span class="at">mode =</span> <span class="st">&#39;nonparametric&#39;</span>, <span class="at">n.break.ties =</span> <span class="dv">10</span>)</span></code></pre></div>
<p>The argument <code>n.break.ties</code> specifies the number of
replicates used to break ties when ranking relative abundances for each
taxon, and the default is <code>n.break.ties = 100</code>.</p>
<p>In parametric mode, MIDASim fits the generalized gamma model, a
three-parameter distribution in the location-scale family that was
proposed for analyzing right-censored survival data to the relative
abundance data of each taxon separately.</p>
<p>Denote the simulated relative abundance for <span class="math inline">\(i\)</span>-th subject and <span class="math inline">\(j\)</span>-th taxon as <span class="math inline">\(\tilde{\pi}_{ij}\)</span>. We define ``survival
time’’ <span class="math display">\[\begin{equation}
\label{eq:survivalTime}
    \tilde{t}_{ij} =
    \begin{cases}
\frac{1}{\tilde{\pi}_{ij}} &amp; \text{if } \tilde{\pi}_{ij} &gt; 0
\\
N_i &amp; \text{if } \tilde{\pi}_{ij} = 0 \\
\end{cases}
\end{equation}\]</span> which corresponds to treating <span class="math inline">\(\tilde{t}_{ij}\)</span> as right-censored when
<span class="math inline">\(\pi_{ij}&lt;\frac{1}{N_i}\)</span>. The
generalized gamma model then assumes <span class="math inline">\(\widetilde{t}_{ij}\)</span> has the distribution
specified by <span class="math display">\[\begin{equation}\label{eq:logLinear}
\ln(\tilde{t}_{ij}) =- \mu_j + s_j\sigma_j \cdot \omega_{ij}~,
\end{equation}\]</span> where <span class="math inline">\(e^{\omega_{ij}}\)</span> follows a gamma
distribution with shape parameter <span class="math inline">\(k_j =
1/|Q_j|\)</span> and scale parameter 1, and <span class="math inline">\(s_j=\text{sign}(Q_j)\)</span>}.</p>
<p>We estimate the three parameters <span class="math inline">\(\mu_j,
\sigma_j, Q_j\)</span> in <em>MIDASim.setup()</em> using the relative
abundances <span class="math inline">\(\pi_j\)</span> in the
template.</p>
<p>To fit MIDASim in parametric mode to the count.ibd data, use the
following command:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>count.ibd.setup <span class="ot">=</span> <span class="fu">MIDASim.setup</span>(otu.tab, <span class="at">mode =</span> <span class="st">&#39;parametric&#39;</span>)</span></code></pre></div>
<p>The returned values of <em>MIDASim.setup()</em> include the estimated
tetrachoric correlation of observed presence-absence data
(<code>tetra.corr</code>), the estimated Pearson correlation of observed
relative abundances (<code>corr.rel.corrected</code>), the proportion of
non-zero cells for each taxon (<code>taxa.1.prop</code>), the proportion
of non-zero cells for each subject (<code>sample.1.prop</code>), the
observed mean relative abundances of each taxon
(<code>mean.rel.abund</code>), and the observed relative abundances
among non-zero cells for each taxon (<code>rel.abund.1</code>). If mode
= ‘parametric’, the function will also return the estimated parameters
of the generalized gamma distribution (<code>mu.est</code>,
<code>sigma.est</code>, and <code>Q.est</code>).</p>
</div>
<div id="modify-the-fitted-midasim-model" class="section level2" number="2.3">
<h2><span class="header-section-number">2.3</span> Modify the fitted
MIDASim model</h2>
<p>The function <em>MIDASim.modify()</em> sets up quantities required to
simulate data using MIDAS. This function also allows users to modify
library sizes, taxa relative abundances, the location parameters in the
parametric model, taxa proportion of non-zero cells, number of samples.
Note that this is a <strong>required</strong> step even if no adjustment
is made.</p>
<div id="no-modification-at-all" class="section level3" number="2.3.1">
<h3><span class="header-section-number">2.3.1</span> No modification at
all</h3>
<p>The default is no additional adjustment is wanted. The number of
samples and their target library sizes for the simulated data are the
same as that of the template. The following code is an example.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>count.ibd.modified <span class="ot">=</span> <span class="fu">MIDASim.modify</span>(count.ibd.setup, </span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">lib.size =</span> <span class="cn">NULL</span>,</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">mean.rel.abund =</span> <span class="cn">NULL</span>,</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">gengamma.mu =</span> <span class="cn">NULL</span>,</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">sample.1.prop =</span> <span class="cn">NULL</span>,</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">taxa.1.prop =</span> <span class="cn">NULL</span>)</span></code></pre></div>
<p>Next, we will explain how to modify the data features to accommodate
a wide range of simulation scenarios, separately for the nonparametric
and parametric modes.</p>
</div>
<div id="model-modification-in-nonparametric-mode" class="section level3" number="2.3.2">
<h3><span class="header-section-number">2.3.2</span> Model modification
in nonparametric mode</h3>
<p>We provide options for modifying the model under the nonparametric
mode. However, it’s important to note that such modifications may not be
as controlled as in parametric mode. For example, if we wish to change
the library sizes of certain observations or the relative abundances of
various taxa, it is not clear how the proportion of non-zero taxa should
change in the nonparametric mode.</p>
<p>In nonparametric mode, users are able to modify the sample size,
library sizes, taxa relative abundances, taxa proportion of non-zero
cells.</p>
<div id="modify-the-number-of-samples-and-their-library-sizes" class="section level4" number="2.3.2.1">
<h4><span class="header-section-number">2.3.2.1</span> Modify the number
of samples and their library sizes</h4>
<p>To change the library sizes, set the <code>lib.size</code> argument
equal to a vector with the target library sizes. The number of samples
can be modified implicitly by specifying library sizes with a vector
length equal to the desired sample size.</p>
<p>Note that, if we wish to change the library sizes, the proportion of
non-zero taxa would also change. Typically, larger library sizes are
accompanied by fewer zero cells. However, since the model is
nonparametric, there is no simple parametric relationship between the
changes in zero cells and relative abundances. <em>MIDASim.modify()</em>
requires the user to specify the marginal totals of non-zeros together
when a change in <code>lib.size</code> is made. This can be achieved by
providing the marginal proportions using the <code>sample.1.prop</code>
and <code>taxa.1.prop</code> arguments within the function.”</p>
<p>An example way determine the appropriate number of non-zero cells for
the new library size is to fit a Shape Constrained Additive model (SCAM)
model <span class="math display">\[ log10(Z_{i.}) =
f\left(log_{10}(N_{i})\right)+\epsilon_i\]</span> where <span class="math inline">\(f\)</span> is a monotone smoothing spline, <span class="math inline">\(Z_{i\cdot}\)</span> is the number of non-zero
cells in each sample, <span class="math inline">\(\epsilon_i\)</span> is
the error term. We could adjust the number of non-zero cells for each
taxon in a way that satisfies the constraint that the product of
<code>sample.1.prop</code> and the number of taxa should be equal to the
product of <code>taxa.1.prop</code> and the number of samples,</p>
<p><span class="math display">\[Z_{i.}\times J = Z_{.j}\times
n\]</span></p>
<p>For example, if we want to generate data with library sizes uniformly
distributed between 1,000 and 10,000 while changing the number of
samples to 700 and allowing the proportion of non-zero cells to adjust
according to the SCAM model, we can start by generating the marginal
totals of non-zero cells and transforming the totals to proportions
using the following:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>new.lib.size <span class="ot">=</span> <span class="fu">sample</span>(<span class="dv">1000</span><span class="sc">:</span><span class="dv">10000</span>, <span class="at">size=</span><span class="dv">700</span>, <span class="at">replace=</span><span class="cn">TRUE</span>)</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>obs.sample.<span class="fl">1.</span>ct <span class="ot">=</span> <span class="fu">rowSums</span>(count.ibd <span class="sc">&gt;</span> <span class="dv">0</span>)</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>xvar <span class="ot">=</span> <span class="fu">log10</span>(<span class="fu">rowSums</span>(count.ibd))</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>scamfit.non0 <span class="ot">=</span> scam<span class="sc">::</span><span class="fu">scam</span>( <span class="fu">log10</span>(obs.sample.<span class="fl">1.</span>ct) <span class="sc">~</span>  <span class="fu">s</span>( xvar, <span class="at">bs =</span> <span class="st">&quot;mpi&quot;</span> ))</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>sample.<span class="fl">1.</span>ct <span class="ot">=</span> <span class="dv">10</span><span class="sc">^</span>(<span class="fu">predict</span>(scamfit.non0,</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>                           <span class="at">newdata =</span> <span class="fu">data.frame</span>(<span class="at">xvar =</span> <span class="fu">log10</span>(new.lib.size) )) )</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>n.taxa <span class="ot">=</span> <span class="fu">ncol</span>(count.ibd)</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>new.sample.<span class="fl">1.</span>prop <span class="ot">=</span> sample.<span class="fl">1.</span>ct<span class="sc">/</span>n.taxa</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>new.taxa.<span class="fl">1.</span>prop <span class="ot">=</span> fitted<span class="sc">$</span>taxa.<span class="fl">1.</span>prop <span class="sc">*</span> (<span class="fu">sum</span>(new.sample.<span class="fl">1.</span>prop) <span class="sc">*</span> n.taxa <span class="sc">/</span> <span class="dv">700</span>) <span class="sc">/</span> <span class="fu">sum</span>(fitted<span class="sc">$</span>taxa.<span class="fl">1.</span>prop)</span></code></pre></div>
<p>Then we can use <em>MIDASim.modify()</em> by</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>count.ibd.modified <span class="ot">=</span> <span class="fu">MIDASim.modify</span>(count.ibd.setup, </span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">lib.size =</span> new.lib.size,</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">sample.1.prop =</span> new.sample.<span class="fl">1.</span>prop,</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">taxa.1.prop =</span> new.taxa.<span class="fl">1.</span>prop)</span></code></pre></div>
</div>
<div id="modify-features-of-taxa-by-mean-relative-abundances-or-proportion-of-non-zero-cells" class="section level4" number="2.3.2.2">
<h4><span class="header-section-number">2.3.2.2</span> Modify features
of taxa by mean relative abundances or proportion of non-zero cells</h4>
<p>If the mean relative abundances are modified, adjustments to the
values of non-zero relative abundances may be necessary. Let <span class="math inline">\(\hat{p}_j\)</span> represent the mean relative
abundances of taxa (mean.rel.abund), <span class="math inline">\(\hat{p}^{(1)}_j\)</span> denote the mean relative
abundances of taxa among non-zero samples (mean.rel.abund.1), and <span class="math inline">\(\hat{\delta}_j\)</span> represent the proportion
of non-zero cells for taxa (taxa.1.prop).</p>
<p>These three quantities are related by <span class="math display">\[\hat{p}_j =
\hat{\delta}_j\hat{p}^{(1)}_j,\]</span></p>
<p>For example, if <span class="math inline">\(\hat{p}_j\)</span> is
altered while keeping <span class="math inline">\(\hat{\delta}j\)</span>
constant, MIDASim calculates the mean relative abundance of non-zero
cells as <span class="math inline">\(p^{(1)}_j=p_j/\delta_j\)</span>.
Subsequently, it determines the value <span class="math inline">\(\alpha_j\)</span> for each taxon in a way that
ensures that <span class="math inline">\({ \pi^\alpha{i,j} |
\pi{ij}&gt;0 }\)</span> has a mean equal to <span class="math inline">\(p^{(1)}_j\)</span> for each taxon.</p>
<p>Suppose we want to increase <span class="math inline">\(log(p_j)\)</span> by <span class="math inline">\(\beta=0.1\)</span> for the first 10 taxa
(e.g. modify these taxa according to a compositional model). The
following is the code for generating a set of target relative abundances
as described,</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>beta <span class="ot">=</span> <span class="fl">0.1</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>new.mean.rel.abund <span class="ot">=</span> count.ibd.setup<span class="sc">$</span>mean.rel.abund</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>new.mean.rel.abund[<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>] <span class="ot">=</span> <span class="fu">exp</span>(beta) <span class="sc">*</span> new.mean.rel.abund[<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>]</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>new.mean.rel.abund <span class="ot">=</span> new.mean.rel.abund <span class="sc">/</span> <span class="fu">sum</span>(new.mean.rel.abund)</span></code></pre></div>
<p>then the target taxa relative abundances can be used in
<em>MIDASim.modify()</em> as the following,</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>count.ibd.modified <span class="ot">=</span> <span class="fu">MIDASim.modify</span>(count.ibd.setup,</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">mean.rel.abund =</span> new.mean.rel.abund)</span></code></pre></div>
<p>Users also have the option to modify the proportion of non-zero cells
for all taxa. However, because this modification affects the overall
total count of non-zero cells throughout the entire dataset, users are
required to specify the marginal proportions of non-zero cells for all
samples.</p>
<p>Suppose we wish to increase the proportion of non-zero cells for
first 10 taxa by 0.05. We can achieve this by</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>new.taxa.<span class="fl">1.</span>prop <span class="ot">=</span> count.ibd.setup<span class="sc">$</span>taxa.<span class="fl">1.</span>prop </span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>new.taxa.<span class="fl">1.</span>prop[<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>] <span class="ot">=</span> new.taxa.<span class="fl">1.</span>prop[<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>] <span class="sc">+</span> <span class="fl">0.05</span></span></code></pre></div>
<p>Then to ensure that appropriate proportions of non-zero cells are
provided for all samples, here we adjust them accordingly by</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>r <span class="ot">=</span> <span class="fu">sum</span>(new.taxa.<span class="fl">1.</span>prop) <span class="sc">/</span> <span class="fu">sum</span>(count.ibd.setup<span class="sc">$</span>taxa.<span class="fl">1.</span>prop)</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>new.sample.<span class="fl">1.</span>prop <span class="ot">=</span> count.ibd.setup<span class="sc">$</span>sample.<span class="fl">1.</span>prop <span class="sc">*</span> r</span></code></pre></div>
<p>then the target proportion of non-zero cells for taxa can be used in
<em>MIDASim.modify()</em> as the following,</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>count.ibd.modified <span class="ot">=</span> <span class="fu">MIDASim.modify</span>(count.ibd.setup,</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">taxa.1.prop =</span> new.taxa.<span class="fl">1.</span>prop,</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">sample.1.prop =</span> new.sample.<span class="fl">1.</span>prop)</span></code></pre></div>
<p>Users can also simultaneously adjust both the mean relative
abundances and the proportion of non-zero cells for taxa using the
following code by</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>count.ibd.modified <span class="ot">=</span> <span class="fu">MIDASim.modify</span>(count.ibd.setup,</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">mean.rel.abund =</span> new.mean.rel.abund,</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">taxa.1.prop =</span> new.taxa.<span class="fl">1.</span>prop,</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">sample.1.prop =</span> new.sample.<span class="fl">1.</span>prop)</span></code></pre></div>
</div>
</div>
<div id="parametric-mode" class="section level3" number="2.3.3">
<h3><span class="header-section-number">2.3.3</span> parametric
mode</h3>
<p>If the parametric mode is chosen in <em>MIDASim.setup()</em>, then
the user are able to modify the sample size, library sizes, taxa
relative abundances, the location parameters in the generalized gamma
distribution.</p>
<p>Changes in the parameters of the parametric model (including library
sizes) imply coordinated changes in all other quantities. After either
modification of the parameters, we predict the probability of being
non-zero of <span class="math inline">\(i\)</span>-th subject and <span class="math inline">\(j\)</span>-th taxon by</p>
<p><span class="math display">\[\begin{equation} \label{gengamma_pred01}
P(\widetilde{Z}_{ij} = 1) = F_j(N_i ~;~ \widehat{\mu}_j,
\widehat{\sigma},_j \widehat{Q}_j),
\end{equation}\]</span> to obtain the number of non-zero cells in each
subject <span class="math inline">\(Z_{i\cdot }\)</span> and that in
each taxon <span class="math inline">\(Z_{\cdot j}\)</span>.</p>
<div id="modify-the-number-of-samples-and-their-library-sizes-1" class="section level4" number="2.3.3.1">
<h4><span class="header-section-number">2.3.3.1</span> Modify the number
of samples and their library sizes</h4>
<p>To change the library sizes, set the <code>lib.size</code> argument
equal to a vector with the target library sizes. The length of this
vector becomes the new number of samples. The advantage of the
parametric mode is that it handles coordinated changes automatically. As
a result, when changing library sizes in parametric mode, there’s no
need for the user to provide the marginal totals of non-zero cells
explicitly.</p>
<p>For example, to generate data having library sizes that are uniformly
distributed between 1,000 and 10,000 while changing the number of
samples to 700, we execute the code</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>new.lib.size <span class="ot">=</span> <span class="fu">sample</span>(<span class="dv">1000</span><span class="sc">:</span><span class="dv">10000</span>, <span class="at">size=</span><span class="dv">700</span>, <span class="at">replace=</span><span class="cn">TRUE</span>)</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>count.ibd.modified <span class="ot">=</span> <span class="fu">MIDASim.modify</span>(count.ibd.setup, </span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">lib.size =</span> new.lib.size)</span></code></pre></div>
</div>
</div>
<div id="modify-taxa-features-by-mean-relative-abundances-or-location-parameters" class="section level3" number="2.3.4">
<h3><span class="header-section-number">2.3.4</span> Modify taxa
features by mean relative abundances or location parameters</h3>
<p>Specifying new values for mean relative abundances
(<code>mean.rel.abund</code>) or location parameters
(<code>gengamma.mu</code>) can modify taxa features.</p>
<p>When mean relative abundances are changed, it effectively adjusts the
location parameters in the parametric model. In this case, when the user
specifies mean relative abundances for taxa, MIDASim automatically
estimates new location parameters for the generalized gamma
distribution. These changes in location parameters influence the
predicted probabilities of non-zero values for each subject and each
taxon, subsequently leading to adjustments in the marginal totals of
non-zero cells.</p>
<p>For example, if we want to increase <span class="math inline">\(log(p_j)\)</span> by <span class="math inline">\(\beta=0.1\)</span> for the first 10 taxa
(e.g. modify these taxa according to a compositional model). The
following is the code for generating a set of target relative abundances
as described,</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>beta <span class="ot">=</span> <span class="fl">0.1</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>new.mean.rel.abund <span class="ot">=</span> count.ibd.setup<span class="sc">$</span>mean.rel.abund</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>new.mean.rel.abund[<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>] <span class="ot">=</span> <span class="fu">exp</span>(beta) <span class="sc">*</span> new.mean.rel.abund[<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>]</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>new.mean.rel.abund <span class="ot">=</span> new.mean.rel.abund <span class="sc">/</span> <span class="fu">sum</span>(new.mean.rel.abund)</span></code></pre></div>
<p>then the target taxa relative abundances can be used in
<em>MIDASim.modify()</em> as the following,</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>count.ibd.modified <span class="ot">=</span> <span class="fu">MIDASim.modify</span>(count.ibd.setup, </span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">mean.rel.abund =</span> new.mean.rel.abund)</span></code></pre></div>
<p>Alternatively, the users can also directly change the location
parameters <span class="math inline">\(\mu_j\)</span> by</p>
<p><span class="math display">\[\mu_j \rightarrow \mu_j + \beta
\]</span></p>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>count.ibd.modified <span class="ot">=</span> <span class="fu">MIDASim.modify</span>(count.ibd.setup, </span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">gengamma.mu =</span> count.ibd.setup<span class="sc">$</span>mu.est <span class="sc">+</span> beta)</span></code></pre></div>
</div>
</div>
<div id="simulate-microbiome-data-with-the-fitted-midas-model" class="section level2" number="2.4">
<h2><span class="header-section-number">2.4</span> Simulate microbiome
data with the fitted MIDAS model</h2>
<p>The function <em>MIDASim()</em> takes the quantities obtained from
<em>MIDASim.modify()</em> and simulates microbiome data. The output is
comprised of the simulated 0/1 (presence-absence) data,
<code>sim_rel</code>, the table of relative abundances, and
<code>sim_count</code>, the table of count data.</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>simulated.data <span class="ot">=</span> <span class="fu">MIDASim</span>(count.ibd.modified)</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(simulated.data)</span></code></pre></div>
</div>
<div id="references" class="section level2" number="2.5">
<h2><span class="header-section-number">2.5</span> References</h2>
<p>[1] Lloyd-Price, J., Arze, C., Ananthakrishnan, A.N. <em>et al</em>.
Multi-omics of the gut microbial ecosystem in inflammatory bowel
diseases. <em>Nature</em> 569, 655–662 (2019). <a href="https://doi.org/10.1038/s41586-019-1237-9" class="uri">https://doi.org/10.1038/s41586-019-1237-9</a>.</p>
<p>[2] Charlson, E.S., Chen, J., Custers-Allen, R. <em>et al</em>.
Disordered microbial communities in the upper respiratory tract of
cigarette smokers. <em>PloS one</em>, 5(12), e15216 (2010). <a href="https://doi.org/10.1371/journal.pone.0015216" class="uri">https://doi.org/10.1371/journal.pone.0015216</a></p>
</div>
</div>



<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
